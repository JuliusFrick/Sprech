name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: macos-14
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'
      
      - name: Install XcodeGen
        run: brew install xcodegen
      
      - name: Generate project
        run: |
          xcodegen generate &
          XCODEGEN_PID=$!
          # Wait max 3 minutes
          for i in {1..180}; do
            sleep 1
            if [ -d "Sprech.xcodeproj" ]; then
              kill $XCODEGEN_PID 2>/dev/null || true
              echo "Project generated!"
              break
            fi
            if ! ps -p $XCODEGEN_PID > /dev/null 2>&1; then
              break
            fi
          done
          # If still no project, fail
          if [ ! -d "Sprech.xcodeproj" ]; then
            kill $XCODEGEN_PID 2>/dev/null || true
            echo "Project NOT generated, checking files..."
            ls -la
            exit 1
          fi
        timeout-minutes: 5
      
      - name: Build
        run: |
          xcodebuild -project Sprech.xcodeproj \
            -scheme Sprech \
            -configuration Release \
            -destination 'platform=macOS' \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
        timeout-minutes: 25
      
      - name: Create DMG
        run: |
          APP_PATH="build/Build/Products/Release/Sprech.app"
          if [ -d "$APP_PATH" ]; then
            create-dmg --volname "Sprech" --window-pos 200 120 --window-size 600 400 \
              --icon-size 100 --icon "Sprech.app" 150 185 \
              --hide-extension "Sprech.app" --app-drop-link 450 185 \
              "Sprech-${{ github.ref_name }}-macOS.dmg" "$APP_PATH" \
            || true
            if [ ! -f "Sprech-${{ github.ref_name }}-macOS.dmg" ]; then
              create-dmg --volname "Sprech" --window-pos 200 120 --window-size 600 400 \
                --icon-size 100 --icon "Sprech.app" 150 185 \
                --hide-extension "Sprech.app" --app-drop-link 450 185 \
                "Sprech-${{ github.ref_name }}-macOS.dmg" "$APP_PATH"
            fi
          else
            find build -name "*.app" -type d
            exit 1
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Sprech ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: Sprech-${{ github.ref_name }}-macOS.dmg
